# IntelliJ IDEA MCP 服务器 - 测试计划

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2025-11-13
- **文档状态**: 测试计划
- **项目名称**: IDEA MCP Server

---

## 1. 测试概述

### 1.1 测试目标

- 确保所有功能按需求正常工作
- 验证系统的稳定性和可靠性
- 发现并修复潜在缺陷
- 确保代码质量达标

### 1.2 测试策略

采用**金字塔测试策略**:

```
        /\
       /  \      E2E 测试 (10%)
      /____\     - 端到端场景测试
     /      \
    /________\   集成测试 (30%)
   /          \  - API 集成测试
  /____________\ - 模块集成测试
 /              \
/________________\ 单元测试 (60%)
                   - 单元功能测试
                   - 边界测试
```

### 1.3 测试范围

**包含**:
- IDEA Plugin 所有功能模块
- MCP Server 工具定义
- HTTP API 端点
- 重构、导航、分析功能
- 错误处理和异常场景

**不包含** (后续迭代):
- 性能压力测试
- 安全渗透测试
- 多语言支持测试 (暂只支持 Kotlin/Java)

### 1.4 测试环境

| 环境 | IDEA版本 | JDK版本 | 操作系统 | 用途 |
|------|---------|---------|---------|------|
| 开发环境 | 2024.1 | 17 | Windows/macOS/Linux | 开发和单元测试 |
| 集成环境 | 2024.1 | 17 | Linux | 集成测试和自动化测试 |
| 验收环境 | 2024.1-2024.3 | 17 | Windows/macOS/Linux | 用户验收测试 |

### 1.5 质量目标

| 指标 | 目标值 | 说明 |
|------|-------|------|
| 单元测试覆盖率 | ≥ 70% | 核心业务逻辑 ≥ 80% |
| 集成测试覆盖率 | ≥ 50% | 主要 API 端点 100% |
| 缺陷修复率 | 100% | Critical/High 级别 |
| 代码审查通过率 | 100% | 所有 PR 必须审查 |
| 自动化测试比例 | ≥ 80% | 可自动化的测试用例 |

---

## 2. 测试执行策略

### 2.1 测试阶段

#### Phase 1: MVP 开发阶段

**时机**: 每完成一个功能模块

**策略**:
- ✅ **单元测试**: 立即编写,随功能开发
- ⏸️ **集成测试**: 暂缓,Phase 1 完成后统一编写
- ⏸️ **E2E 测试**: 手动测试为主

**原则**:
- 关键功能必须有单元测试
- 非关键工具类可以暂缓测试
- 优先保证开发速度

#### Phase 2-4: 功能扩展阶段

**时机**: 每完成一个功能

**策略**:
- ✅ **单元测试**: 立即编写
- ✅ **集成测试**: 重要 API 立即编写
- ⏸️ **E2E 测试**: 手动测试

#### Phase 5: 优化和完善阶段

**时机**: 核心功能完成后

**策略**:
- ✅ **补充测试**: 补充缺失的测试
- ✅ **集成测试**: 完善集成测试套件
- ✅ **E2E 测试**: 自动化关键场景
- ✅ **性能测试**: 性能基准测试
- ✅ **安全测试**: 安全扫描和审计

### 2.2 测试触发时机

| 触发事件 | 测试类型 | 说明 |
|---------|---------|------|
| 代码提交 (Pre-commit) | 代码风格检查 | 自动运行 |
| Pull Request | 单元测试 + 代码审查 | CI 自动运行 |
| 合并到 main | 单元测试 + 集成测试 | CI 自动运行 |
| 发布前 | 完整测试套件 | 手动触发 |
| 每日构建 | 完整测试套件 | 定时自动运行 |

---

## 3. 单元测试

### 3.1 测试框架

- **Java**: JUnit 5 + Mockito + AssertJ
- **TypeScript**: Jest (MCP Server)

### 3.2 测试覆盖目标

| 模块 | 覆盖率目标 | 优先级 |
|------|----------|--------|
| RefactoringService | ≥ 80% | 高 |
| NavigationService | ≥ 80% | 高 |
| AnalysisService | ≥ 80% | 高 |
| HTTP Server | ≥ 70% | 中 |
| 工具类 (Utils) | ≥ 70% | 中 |
| 数据模型 (Models) | ≥ 60% | 低 |

### 3.3 单元测试示例

#### 3.3.1 RefactoringService 测试

```kotlin
// RefactoringServiceTest.kt
package com.ly.ideamcp.service

import com.intellij.openapi.project.Project
import com.intellij.psi.PsiElement
import com.intellij.psi.PsiFile
import com.intellij.refactoring.rename.RenameProcessor
import com.ly.ideamcp.model.RenameRequest
import com.ly.ideamcp.model.RenameResponse
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.extension.ExtendWith
import org.mockito.Mock
import org.mockito.junit.jupiter.MockitoExtension
import org.assertj.core.api.Assertions.*
import org.mockito.Mockito.*

@ExtendWith(MockitoExtension::class)
class RefactoringServiceTest {

    @Mock
    private lateinit var project: Project

    @Mock
    private lateinit var psiFile: PsiFile

    @Mock
    private lateinit var element: PsiElement

    private lateinit var service: RefactoringService

    @BeforeEach
    fun setUp() {
        service = RefactoringService(project)
    }

    @Test
    fun `renameSymbol should succeed when valid input`() {
        // Given
        val request = RenameRequest(
            filePath = "/src/User.java",
            offset = 1234,
            newName = "Customer"
        )

        `when`(psiFile.findElementAt(1234)).thenReturn(element)

        // When
        val response = service.renameSymbol(request)

        // Then
        assertThat(response).isNotNull
        assertThat(response.isSuccess()).isTrue
        assertThat(response.affectedFiles).isNotEmpty
    }

    @Test
    fun `renameSymbol should fail when file not found`() {
        // Given
        val request = RenameRequest(
            filePath = "/nonexistent.java",
            offset = 1234,
            newName = "Customer"
        )

        // When & Then
        assertThatThrownBy { service.renameSymbol(request) }
            .isInstanceOf(FileNotFoundException::class.java)
            .hasMessageContaining("File not found")
    }

    @Test
    fun `renameSymbol should fail when element not found`() {
        // Given
        val request = RenameRequest(
            filePath = "/src/User.java",
            offset = 9999,
            newName = "Customer"
        )

        `when`(psiFile.findElementAt(9999)).thenReturn(null)

        // When & Then
        assertThatThrownBy { service.renameSymbol(request) }
            .isInstanceOf(ElementNotFoundException::class.java)
    }

    @Test
    fun `renameSymbol should detect conflict when name exists`() {
        // Given
        val request = RenameRequest(
            filePath = "/src/User.java",
            offset = 1234,
            newName = "ExistingClass"
        )

        // 模拟命名冲突
        `when`(element.name).thenReturn("User")
        // ... 设置冲突场景

        // When
        val response = service.renameSymbol(request)

        // Then
        assertThat(response.hasConflicts()).isTrue
        assertThat(response.conflicts).hasSize(1)
    }

    @Test
    fun `renameSymbol should support preview when preview enabled`() {
        // Given
        val request = RenameRequest(
            filePath = "/src/User.java",
            offset = 1234,
            newName = "Customer",
            preview = true
        )

        `when`(psiFile.findElementAt(1234)).thenReturn(element)

        // When
        val response = service.renameSymbol(request)

        // Then
        assertThat(response.isPreview()).isTrue
        assertThat(response.changes).isNotEmpty
        verify(psiFile, never()).virtualFile // 确保没有实际修改
    }
}
```

#### 3.3.2 NavigationService 测试

```kotlin
// NavigationServiceTest.kt
@ExtendWith(MockitoExtension::class)
class NavigationServiceTest {

    @Test
    fun `findUsages should return all usages when symbol used`() {
        // Given
        val request = FindUsagesRequest(
            filePath = "/src/User.java",
            offset = 1234,
            scope = "project"
        )

        // When
        val response = service.findUsages(request)

        // Then
        assertThat(response.usages).hasSize(15)
        assertThat(response.groupedByType)
            .containsEntry("METHOD_CALL", 10)
            .containsEntry("FIELD_READ", 5)
    }

    @Test
    fun `findUsages should return empty when symbol not used`() {
        // Test implementation
    }

    @Test
    fun `gotoDefinition should return correct location`() {
        // Test implementation
    }
}
```

### 3.4 测试命名规范

**Kotlin 格式**: 使用反引号包裹的描述性名称

**示例**:
- ✅ `fun \`renameSymbol should succeed when valid input\`()`
- ✅ `fun \`findUsages should return empty when symbol not used\`()`
- ❌ `fun testRename()` (太简单)
- ❌ `fun test1()` (无意义)

### 3.5 单元测试运行

```bash
# 运行所有测试
./gradlew test

# 运行特定测试类
./gradlew test --tests "RefactoringServiceTest"

# 运行特定测试方法
./gradlew test --tests "RefactoringServiceTest.renameSymbol_shouldSucceed_whenValidInput"

# 生成覆盖率报告
./gradlew test jacocoTestReport
# 报告位置: build/reports/jacoco/test/html/index.html
```

---

## 4. 集成测试

### 4.1 测试范围

- HTTP API 端点
- IDEA Plugin 与 PSI 交互
- 重构操作的完整流程
- 跨模块功能

### 4.2 集成测试示例

#### 4.2.1 HTTP API 测试

```kotlin
// RenameApiIntegrationTest.kt
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class RenameApiIntegrationTest {

    @LocalServerPort
    private var port: Int = 0

    private val restTemplate = RestTemplate()

    @Test
    fun `renameApi should return 200 when valid request`() {
        // Given
        val url = "http://localhost:$port/api/v1/refactor/rename"
        val request = RenameRequest(
            filePath = "/src/User.java",
            offset = 1234,
            newName = "Customer"
        )

        // When
        val response = restTemplate.postForEntity(
            url, request, RenameResponse::class.java
        )

        // Then
        assertThat(response.statusCode).isEqualTo(HttpStatus.OK)
        assertThat(response.body).isNotNull
        assertThat(response.body?.isSuccess()).isTrue
    }

    @Test
    fun `renameApi should return 404 when file not found`() {
        // Test implementation
    }

    @Test
    fun `renameApi should return 400 when invalid offset`() {
        // Test implementation
    }
}
```

#### 4.2.2 完整重构流程测试

```kotlin
// RefactoringIntegrationTest.kt
@ExtendWith(IdeaTestExtension::class) // 自定义 IDEA 测试扩展
class RefactoringIntegrationTest {

    @Test
    fun `renameClass should update all references`() {
        // Given: 创建测试项目和文件
        val project = createTestProject()
        val userFile = createFile("User.java", """
            public class User {
                private String name;
                public String getName() { return name; }
            }
        """.trimIndent())
        val serviceFile = createFile("Service.java", """
            public class Service {
                private User user = new User();
            }
        """.trimIndent())

        // When: 重命名 User -> Customer
        val request = RenameRequest(
            filePath = "User.java",
            offset = 13, // "User" 位置
            newName = "Customer"
        )

        val service = RefactoringService(project)
        val response = service.renameSymbol(request)

        // Then: 验证所有引用都被更新
        assertThat(response.isSuccess()).isTrue
        assertThat(response.affectedFiles).hasSize(2)

        val userContent = readFile("User.java")
        assertThat(userContent).contains("public class Customer")

        val serviceContent = readFile("Service.java")
        assertThat(serviceContent).contains("private Customer user = new Customer()")
    }
}
```

### 4.3 集成测试运行

```bash
# 运行集成测试
./gradlew integrationTest

# 或使用标签
./gradlew test --tests "*IntegrationTest"
```

---

## 5. 端到端 (E2E) 测试

### 5.1 测试场景

#### 场景 1: AI 工具通过 MCP 重命名类

**前置条件**:
- IDEA 打开项目
- IDEA Plugin 运行
- MCP Server 运行

**步骤**:
1. AI 工具 (Claude Code) 发送重命名请求到 MCP Server (stdio)
2. MCP Server 转换请求为 HTTP 请求
3. MCP Server 发送 HTTP 请求到 IDEA Plugin (localhost:58888)
4. IDEA Plugin 执行重命名
5. IDEA Plugin 返回结果
6. MCP Server 格式化为 MCP 响应
7. AI 工具接收响应

**验证**:
- ✅ 类名成功重命名
- ✅ 所有引用已更新
- ✅ AI 工具显示正确结果

#### 场景 2: 查找用途并分析

**步骤**:
1. AI 工具请求查找方法用途
2. IDEA Plugin 返回所有使用位置
3. AI 工具分析使用情况并提供建议

**验证**:
- ✅ 找到所有使用位置
- ✅ 按类型分组正确
- ✅ 上下文信息完整

### 5.2 手动测试清单

#### 基础功能清单

| 功能 | 测试项 | 状态 | 备注 |
|------|-------|------|------|
| HTTP Server | 启动成功 | [ ] | |
| | 健康检查返回 200 | [ ] | |
| | 端口可配置 | [ ] | |
| 重命名 | 重命名类 | [ ] | |
| | 重命名方法 | [ ] | |
| | 重命名变量 | [ ] | |
| | 检测命名冲突 | [ ] | |
| | 预览模式 | [ ] | |
| 查找用途 | 查找方法用途 | [ ] | |
| | 查找字段用途 | [ ] | |
| | 按类型分组 | [ ] | |
| 跳转定义 | 跳转到类定义 | [ ] | |
| | 跳转到方法定义 | [ ] | |
| | 跨文件跳转 | [ ] | |
| 代码检查 | 运行检查 | [ ] | |
| | 过滤严重程度 | [ ] | |
| | 快速修复建议 | [ ] | |

#### 异常场景清单

| 场景 | 预期结果 | 状态 |
|------|---------|------|
| 文件不存在 | 返回 404 错误 | [ ] |
| 偏移量无效 | 返回 400 错误 | [ ] |
| 元素未找到 | 返回 404 错误 | [ ] |
| 索引未就绪 | 返回 503 错误 | [ ] |
| 重构冲突 | 返回冲突信息 | [ ] |
| 并发请求 | 正常处理 | [ ] |
| 超时请求 | 返回 504 错误 | [ ] |

---

## 6. 性能测试 (Phase 5)

### 6.1 性能指标

| 操作 | 目标响应时间 | 并发数 | 说明 |
|------|------------|--------|------|
| 健康检查 | < 100ms | 50 | 快速检查 |
| 跳转定义 | < 500ms | 10 | 简单操作 |
| 查找用途 | < 2s | 10 | 中等操作 |
| 重命名 (小) | < 3s | 5 | 影响 < 10 个文件 |
| 重命名 (大) | < 10s | 2 | 影响 > 50 个文件 |
| 代码检查 (文件) | < 5s | 5 | 单文件检查 |
| 代码检查 (项目) | < 60s | 1 | 全项目检查 |

### 6.2 压力测试

**工具**: JMeter / Gatling

**场景**:
- 并发 10 个查找用途请求
- 持续 5 分钟重命名操作
- 100 个并发健康检查

**验证**:
- 响应时间符合目标
- 无内存泄漏
- 无崩溃或死锁

---

## 7. 安全测试 (Phase 5)

### 7.1 测试项

| 测试项 | 说明 | 工具 |
|-------|------|------|
| 认证测试 | 验证 Token 认证 | 手动 |
| 授权测试 | 验证权限控制 | 手动 |
| 注入测试 | SQL/命令注入 | OWASP ZAP |
| XSS 测试 | 跨站脚本 | OWASP ZAP |
| CSRF 测试 | 跨站请求伪造 | 手动 |
| 敏感信息 | 日志/响应中的敏感信息 | 代码审查 |
| 依赖漏洞 | 第三方依赖漏洞扫描 | Snyk |

### 7.2 安全测试清单

- [ ] Token 认证正常工作
- [ ] 无效 Token 被拒绝
- [ ] 默认仅监听 localhost
- [ ] 日志不包含敏感信息
- [ ] 依赖库无已知高危漏洞
- [ ] 危险操作需要确认

---

## 8. 回归测试

### 8.1 回归测试策略

**触发时机**:
- 修复 Bug 后
- 重构代码后
- 新功能添加后
- 发布前

**测试范围**:
- 核心功能 (重命名、查找用途、跳转定义)
- 上次发现 Bug 的区域
- 与本次修改相关的功能

### 8.2 回归测试套件

```bash
# 快速回归 (5分钟)
./gradlew test --tests "**/*CoreTest"

# 完整回归 (20分钟)
./gradlew test integrationTest

# 冒烟测试 (1分钟)
./gradlew smokeTest
```

---

## 9. 测试自动化

### 9.1 CI/CD 集成

#### GitHub Actions 示例

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
      - name: Run unit tests
        run: ./gradlew test
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  integration-test:
    needs: unit-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run integration tests
        run: ./gradlew integrationTest
```

### 9.2 Pre-commit Hook

```bash
# .git/hooks/pre-commit
#!/bin/sh

echo "Running pre-commit tests..."

# 代码风格检查
./gradlew checkstyleMain

# 快速测试
./gradlew test --tests "**/*UnitTest"

if [ $? -ne 0 ]; then
  echo "Tests failed. Commit aborted."
  exit 1
fi

echo "Tests passed. Proceeding with commit."
```

---

## 10. 缺陷管理

### 10.1 缺陷优先级

| 优先级 | 描述 | 响应时间 | 示例 |
|-------|------|---------|------|
| Critical | 系统崩溃、数据丢失 | 立即 | Plugin 无法启动 |
| High | 核心功能不可用 | 1天 | 重命名功能失败 |
| Medium | 功能部分可用 | 3天 | 预览模式显示不正确 |
| Low | 小问题、优化建议 | 1周 | UI 文案错误 |

### 10.2 缺陷报告模板

```markdown
## 缺陷描述
简要描述问题

## 重现步骤
1. 打开项目
2. 执行重命名操作
3. 观察结果

## 预期结果
应该成功重命名

## 实际结果
返回 500 错误

## 环境信息
- IDEA 版本: 2024.1
- Plugin 版本: 1.0.0
- 操作系统: Windows 11
- JDK 版本: 17

## 附加信息
- 日志文件
- 截图
```

---

## 11. 测试报告

### 11.1 测试报告模板

```markdown
# 测试报告 - Version 1.0.0

## 测试概要
- **测试日期**: 2025-11-20
- **测试人员**: 张三
- **测试版本**: 1.0.0-SNAPSHOT
- **测试环境**: Windows 11 + IDEA 2024.1 + JDK 17

## 测试统计
| 类型 | 总数 | 通过 | 失败 | 阻塞 | 通过率 |
|------|-----|------|------|------|-------|
| 单元测试 | 120 | 115 | 5 | 0 | 95.8% |
| 集成测试 | 45 | 40 | 5 | 0 | 88.9% |
| E2E 测试 | 20 | 18 | 2 | 0 | 90.0% |
| **总计** | **185** | **173** | **12** | **0** | **93.5%** |

## 测试覆盖率
| 模块 | 行覆盖率 | 分支覆盖率 | 目标 | 状态 |
|------|---------|----------|------|------|
| RefactoringService | 82% | 75% | 80% | ✅ |
| NavigationService | 78% | 70% | 80% | ⚠️ |
| AnalysisService | 71% | 65% | 80% | ⚠️ |
| **总体** | **75%** | **68%** | **70%** | **✅** |

## 发现的问题
### Critical (0个)
无

### High (2个)
1. [#123] 重命名时未更新所有引用
2. [#124] 索引未就绪时返回错误码不正确

### Medium (5个)
...

## 测试结论
✅ 通过 / ⚠️ 有风险 / ❌ 不通过

## 建议
1. 补充 NavigationService 单元测试
2. 修复 High 优先级缺陷后重新测试
```

---

## 12. 测试工具

### 12.1 推荐工具

| 工具 | 用途 | 链接 |
|------|------|------|
| JUnit 5 | Java 单元测试 | https://junit.org/junit5/ |
| Mockito | Mock 框架 | https://site.mockito.org/ |
| AssertJ | 断言库 | https://assertj.github.io/doc/ |
| JaCoCo | 代码覆盖率 | https://www.jacoco.org/ |
| Postman | API 测试 | https://www.postman.com/ |
| JMeter | 性能测试 | https://jmeter.apache.org/ |
| OWASP ZAP | 安全测试 | https://www.zaproxy.org/ |

---

## 附录: 测试数据

### A.1 测试项目

准备测试项目:

```
test-project/
├── src/main/java/
│   ├── User.java
│   ├── UserService.java
│   └── UserRepository.java
└── src/test/java/
    └── UserServiceTest.java
```

### A.2 测试用例

完整测试用例列表见: `test-cases.xlsx`

---

**文档维护**: 测试计划和策略变更时需更新此文档。
